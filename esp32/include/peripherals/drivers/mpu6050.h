#pragma once

#include <peripherals/i2c_bus.h>
#include <utils/math_utils.h>

class MPU6050Driver {
  public:
    static constexpr uint8_t DEFAULT_ADDR = 0x68;

    MPU6050Driver(uint8_t addr = DEFAULT_ADDR) : _addr(addr) {}

    bool begin() {
        if (!I2CBus::instance().probe(_addr)) return false;

        uint8_t whoami = readReg(REG_WHO_AM_I);
        if (whoami != 0x68 && whoami != 0x72) return false;

        if (dmpInitialize() != 0) return false;

        setDMPEnabled(true);
        vTaskDelay(pdMS_TO_TICKS(100));
        resetFIFO();
        vTaskDelay(pdMS_TO_TICKS(50));

        _initialized = true;
        return true;
    }

    bool update() {
        if (!_initialized) return false;

        if (dmpGetCurrentFIFOPacket(_fifoBuffer)) {
            float q[4];
            dmpGetQuaternion(q, _fifoBuffer);
            dmpGetGravity(_gravity, q);
            dmpGetYawPitchRoll(_rpy, q, _gravity);
        }

        uint8_t buf[2];
        if (I2CBus::instance().readReg(_addr, REG_TEMP_OUT_H, buf, 2) == ESP_OK) {
            int16_t rawTemp = (buf[0] << 8) | buf[1];
            _temp = rawTemp / 340.0f + 36.53f;
        }

        return true;
    }

    bool calibrate() {
        if (!_initialized) return false;

        CalibrateGyro(6);
        CalibrateAccel(6);

        return true;
    }

    float getRoll() const { return _rpy[2]; }
    float getPitch() const { return _rpy[1]; }
    float getYaw() const { return _rpy[0]; }
    float getTemperature() const { return _temp; }
    bool isInitialized() const { return _initialized; }

  private:
    static constexpr uint8_t REG_XG_OFFS_USRH = 0x13;
    static constexpr uint8_t REG_XA_OFFS_H = 0x06;
    static constexpr uint8_t REG_SMPLRT_DIV = 0x19;
    static constexpr uint8_t REG_CONFIG = 0x1A;
    static constexpr uint8_t REG_GYRO_CONFIG = 0x1B;
    static constexpr uint8_t REG_ACCEL_CONFIG = 0x1C;
    static constexpr uint8_t REG_FIFO_EN = 0x23;
    static constexpr uint8_t REG_INT_PIN_CFG = 0x37;
    static constexpr uint8_t REG_INT_ENABLE = 0x38;
    static constexpr uint8_t REG_INT_STATUS = 0x3A;
    static constexpr uint8_t REG_ACCEL_XOUT_H = 0x3B;
    static constexpr uint8_t REG_TEMP_OUT_H = 0x41;
    static constexpr uint8_t REG_GYRO_XOUT_H = 0x43;
    static constexpr uint8_t REG_SIGNAL_PATH_RESET = 0x68;
    static constexpr uint8_t REG_USER_CTRL = 0x6A;
    static constexpr uint8_t REG_PWR_MGMT_1 = 0x6B;
    static constexpr uint8_t REG_PWR_MGMT_2 = 0x6C;
    static constexpr uint8_t REG_BANK_SEL = 0x6D;
    static constexpr uint8_t REG_MEM_START_ADDR = 0x6E;
    static constexpr uint8_t REG_MEM_R_W = 0x6F;
    static constexpr uint8_t REG_DMP_CFG_1 = 0x70;
    static constexpr uint8_t REG_DMP_CFG_2 = 0x71;
    static constexpr uint8_t REG_FIFO_COUNT_H = 0x72;
    static constexpr uint8_t REG_FIFO_R_W = 0x74;
    static constexpr uint8_t REG_WHO_AM_I = 0x75;

    static constexpr uint16_t DMP_PACKET_SIZE = 28;
    static constexpr uint16_t DMP_CODE_SIZE = 3062;

    static constexpr uint8_t dmpMemory[DMP_CODE_SIZE] = {
        0x00, 0xF8, 0xF6, 0x2A, 0x3F, 0x68, 0xF5, 0x7A, 0x00, 0x06, 0xFF, 0xFE, 0x00, 0x03, 0x00, 0x00, 0x00, 0x65,
        0x00, 0x54, 0xFF, 0xEF, 0x00, 0x00, 0xFA, 0x80, 0x00, 0x0B, 0x12, 0x82, 0x00, 0x01, 0x03, 0x0C, 0x30, 0xC3,
        0x0A, 0x74, 0x56, 0x2D, 0x0D, 0x62, 0xDB, 0xC7, 0x16, 0xF4, 0xBA, 0x02, 0x38, 0x83, 0xF8, 0x83, 0x30, 0x00,
        0xF8, 0x83, 0x25, 0x8E, 0xF8, 0x83, 0x30, 0x00, 0xF8, 0x83, 0xFF, 0xFF, 0xFF, 0xFF, 0x0C, 0xBD, 0xD8, 0x11,
        0x24, 0x00, 0x04, 0x00, 0x1A, 0x82, 0x79, 0xA1, 0x00, 0x36, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10,
        0x00, 0x00, 0x38, 0x83, 0x6F, 0xA2, 0x00, 0x3E, 0x03, 0x30, 0x40, 0x00, 0x00, 0x00, 0x02, 0xCA, 0xE3, 0x09,
        0x3E, 0x80, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x60, 0x00,
        0x00, 0x00, 0x1F, 0xA4, 0xE8, 0xE4, 0xFF, 0xF5, 0xDC, 0xB9, 0x00, 0x5B, 0x79, 0xCF, 0x1F, 0x3F, 0x78, 0x76,
        0x00, 0x86, 0x7C, 0x5A, 0x00, 0x86, 0x23, 0x47, 0xFA, 0xB9, 0x86, 0x31, 0x00, 0x74, 0x87, 0x8A, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x43, 0x05, 0xFF, 0xFF, 0xE9, 0xA8, 0x00, 0x00, 0x21, 0x82, 0xFA, 0xB8, 0x4D, 0x46,
        0xFF, 0xFA, 0xDF, 0x3D, 0xFF, 0xFF, 0xB2, 0xB3, 0x00, 0x00, 0x00, 0x00, 0x3F, 0xFF, 0xBA, 0x98, 0x00, 0x5D,
        0xAC, 0x08, 0x00, 0x0A, 0x63, 0x78, 0x00, 0x01, 0x46, 0x21, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x42, 0xB5,
        0x00, 0x06, 0x00, 0x64, 0x00, 0x64, 0x00, 0x06, 0x14, 0x06, 0x02, 0x9F, 0x0F, 0x47, 0x91, 0x32, 0xD9, 0x0E,
        0x9F, 0xC9, 0x1D, 0xCF, 0x4C, 0x34, 0x3B, 0xB6, 0x7A, 0xE8, 0x00, 0x64, 0x00, 0x06, 0x00, 0xC8, 0x00, 0x00,
        0x00, 0x00, 0xFF, 0xFE, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0xFF, 0xF1, 0x00, 0x00, 0xFA, 0x46, 0x00, 0x00, 0xA2, 0xB8, 0x00, 0x00,
        0x10, 0x00, 0x00, 0x00, 0x04, 0xD6, 0x00, 0x00, 0x04, 0xCC, 0x00, 0x00, 0x04, 0xCC, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x02,
        0x00, 0x05, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x0C, 0x00, 0x05, 0x00, 0x64, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x32, 0xF8, 0x98, 0x00, 0x00, 0xFF, 0x65,
        0x00, 0x00, 0x83, 0x0F, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0xFF, 0xF1, 0x00, 0x00, 0xFA, 0x46, 0x00, 0x00,
        0xA2, 0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0xB2, 0x6A, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01,
        0xFB, 0x83, 0x00, 0x7C, 0x00, 0x00, 0xFB, 0x15, 0xFC, 0x00, 0x1F, 0xB4, 0xFF, 0x83, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x65, 0x00, 0x07, 0x00, 0x64, 0x03, 0xE8, 0x00, 0x64, 0x00, 0x28, 0x00, 0x00, 0xFF, 0xFD, 0x00, 0x00,
        0x00, 0x00, 0x16, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x2F, 0x00, 0x00,
        0x00, 0x00, 0x01, 0xF4, 0x00, 0x00, 0x10, 0x00, 0x00, 0x28, 0x00, 0x00, 0xFF, 0xFF, 0x45, 0x81, 0xFF, 0xFF,
        0xFA, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x00, 0x01, 0x00, 0x05, 0xBA, 0xC6,
        0x00, 0x47, 0x78, 0xA2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
        0x00, 0x14, 0x00, 0x00, 0x23, 0xBB, 0x00, 0x2E, 0xA2, 0x5B, 0x00, 0x00, 0x05, 0x68, 0x00, 0x0B, 0xCF, 0x49,
        0x00, 0x04, 0xFF, 0xFD, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1B,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x00, 0x07,
        0x00, 0x08, 0x00, 0x06, 0x00, 0x06, 0xFF, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2E, 0xA2, 0x5B, 0x00, 0x00, 0x05, 0x68, 0x00, 0x0B, 0xCF, 0x49,
        0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xF6, 0x2A, 0x3F, 0x68, 0xF5, 0x7A, 0x00, 0x04, 0xFF, 0xFD, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x0E,
        0xFF, 0xFF, 0xFF, 0xCF, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x32, 0xFF, 0xFF, 0xFF, 0x9C, 0x00, 0x00,
        0x43, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x64, 0xFF, 0xE5, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x01, 0x80, 0x00,
        0x00, 0x01, 0x80, 0x00, 0x00, 0x24, 0x26, 0xD3, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x10, 0x00, 0x96, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x1F, 0x9E, 0x65, 0x5D, 0x0C, 0x0A, 0x4E, 0x68, 0xCD, 0xCF, 0x77, 0x09, 0x50, 0x16, 0x67, 0x59, 0xC6, 0x19,
        0xCE, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x47, 0x71, 0x1C,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x17, 0xD7, 0x84, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x11,
        0xDC, 0x47, 0x03, 0x00, 0x00, 0x00, 0xC7, 0x93, 0x8F, 0x9D, 0x1E, 0x1B, 0x1C, 0x19, 0xFF, 0xFF, 0xFF, 0xFF,
        0x00, 0x00, 0x00, 0x00, 0x0E, 0xDF, 0xA4, 0x38, 0x1F, 0x9E, 0x65, 0x5D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x47,
        0x71, 0x1C, 0x02, 0x03, 0x18, 0x85, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xFD, 0xFF, 0xFF, 0xF4, 0xC9, 0xFF, 0xFF,
        0xBC, 0xF0, 0x00, 0x01, 0x0C, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0xF5, 0xB7, 0xBA, 0xB3, 0x67, 0x7D, 0xDF, 0x7E, 0x72, 0x90, 0x2E, 0x55, 0x4C, 0xF6, 0xE6, 0x88,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xD8, 0xDC,
        0xB4, 0xB8, 0xB0, 0xD8, 0xB9, 0xAB, 0xF3, 0xF8, 0xFA, 0xB3, 0xB7, 0xBB, 0x8E, 0x9E, 0xAE, 0xF1, 0x32, 0xF5,
        0x1B, 0xF1, 0xB4, 0xB8, 0xB0, 0x80, 0x97, 0xF1, 0xA9, 0xDF, 0xDF, 0xDF, 0xAA, 0xDF, 0xDF, 0xDF, 0xF2, 0xAA,
        0x4C, 0xCD, 0x6C, 0xA9, 0x0C, 0xC9, 0x2C, 0x97, 0xF1, 0xA9, 0x89, 0x26, 0x46, 0x66, 0xB2, 0x89, 0x99, 0xA9,
        0x2D, 0x55, 0x7D, 0xB0, 0xB0, 0x8A, 0xA8, 0x96, 0x36, 0x56, 0x76, 0xF1, 0xBA, 0xA3, 0xB4, 0xB2, 0x80, 0xC0,
        0xB8, 0xA8, 0x97, 0x11, 0xB2, 0x83, 0x98, 0xBA, 0xA3, 0xF0, 0x24, 0x08, 0x44, 0x10, 0x64, 0x18, 0xB2, 0xB9,
        0xB4, 0x98, 0x83, 0xF1, 0xA3, 0x29, 0x55, 0x7D, 0xBA, 0xB5, 0xB1, 0xA3, 0x83, 0x93, 0xF0, 0x00, 0x28, 0x50,
        0xF5, 0xB2, 0xB6, 0xAA, 0x83, 0x93, 0x28, 0x54, 0x7C, 0xF1, 0xB9, 0xA3, 0x82, 0x93, 0x61, 0xBA, 0xA2, 0xDA,
        0xDE, 0xDF, 0xDB, 0x81, 0x9A, 0xB9, 0xAE, 0xF5, 0x60, 0x68, 0x70, 0xF1, 0xDA, 0xBA, 0xA2, 0xDF, 0xD9, 0xBA,
        0xA2, 0xFA, 0xB9, 0xA3, 0x82, 0x92, 0xDB, 0x31, 0xBA, 0xA2, 0xD9, 0xBA, 0xA2, 0xF8, 0xDF, 0x85, 0xA4, 0xD0,
        0xC1, 0xBB, 0xAD, 0x83, 0xC2, 0xC5, 0xC7, 0xB8, 0xA2, 0xDF, 0xDF, 0xDF, 0xBA, 0xA0, 0xDF, 0xDF, 0xDF, 0xD8,
        0xD8, 0xF1, 0xB8, 0xAA, 0xB3, 0x8D, 0xB4, 0x98, 0x0D, 0x35, 0x5D, 0xB2, 0xB6, 0xBA, 0xAF, 0x8C, 0x96, 0x19,
        0x8F, 0x9F, 0xA7, 0x0E, 0x16, 0x1E, 0xB4, 0x9A, 0xB8, 0xAA, 0x87, 0x2C, 0x54, 0x7C, 0xBA, 0xA4, 0xB0, 0x8A,
        0xB6, 0x91, 0x32, 0x56, 0x76, 0xB2, 0x84, 0x94, 0xA4, 0xC8, 0x08, 0xCD, 0xD8, 0xB8, 0xB4, 0xB0, 0xF1, 0x99,
        0x82, 0xA8, 0x2D, 0x55, 0x7D, 0x98, 0xA8, 0x0E, 0x16, 0x1E, 0xA2, 0x2C, 0x54, 0x7C, 0x92, 0xA4, 0xF0, 0x2C,
        0x50, 0x78, 0xF1, 0x84, 0xA8, 0x98, 0xC4, 0xCD, 0xFC, 0xD8, 0x0D, 0xDB, 0xA8, 0xFC, 0x2D, 0xF3, 0xD9, 0xBA,
        0xA6, 0xF8, 0xDA, 0xBA, 0xA6, 0xDE, 0xD8, 0xBA, 0xB2, 0xB6, 0x86, 0x96, 0xA6, 0xD0, 0xF3, 0xC8, 0x41, 0xDA,
        0xA6, 0xC8, 0xF8, 0xD8, 0xB0, 0xB4, 0xB8, 0x82, 0xA8, 0x92, 0xF5, 0x2C, 0x54, 0x88, 0x98, 0xF1, 0x35, 0xD9,
        0xF4, 0x18, 0xD8, 0xF1, 0xA2, 0xD0, 0xF8, 0xF9, 0xA8, 0x84, 0xD9, 0xC7, 0xDF, 0xF8, 0xF8, 0x83, 0xC5, 0xDA,
        0xDF, 0x69, 0xDF, 0x83, 0xC1, 0xD8, 0xF4, 0x01, 0x14, 0xF1, 0xA8, 0x82, 0x4E, 0xA8, 0x84, 0xF3, 0x11, 0xD1,
        0x82, 0xF5, 0xD9, 0x92, 0x28, 0x97, 0x88, 0xF1, 0x09, 0xF4, 0x1C, 0x1C, 0xD8, 0x84, 0xA8, 0xF3, 0xC0, 0xF9,
        0xD1, 0xD9, 0x97, 0x82, 0xF1, 0x29, 0xF4, 0x0D, 0xD8, 0xF3, 0xF9, 0xF9, 0xD1, 0xD9, 0x82, 0xF4, 0xC2, 0x03,
        0xD8, 0xDE, 0xDF, 0x1A, 0xD8, 0xF1, 0xA2, 0xFA, 0xF9, 0xA8, 0x84, 0x98, 0xD9, 0xC7, 0xDF, 0xF8, 0xF8, 0xF8,
        0x83, 0xC7, 0xDA, 0xDF, 0x69, 0xDF, 0xF8, 0x83, 0xC3, 0xD8, 0xF4, 0x01, 0x14, 0xF1, 0x98, 0xA8, 0x82, 0x2E,
        0xA8, 0x84, 0xF3, 0x11, 0xD1, 0x82, 0xF5, 0xD9, 0x92, 0x50, 0x97, 0x88, 0xF1, 0x09, 0xF4, 0x1C, 0xD8, 0x84,
        0xA8, 0xF3, 0xC0, 0xF8, 0xF9, 0xD1, 0xD9, 0x97, 0x82, 0xF1, 0x49, 0xF4, 0x0D, 0xD8, 0xF3, 0xF9, 0xF9, 0xD1,
        0xD9, 0x82, 0xF4, 0xC4, 0x03, 0xD8, 0xDE, 0xDF, 0xD8, 0xF1, 0xAD, 0x88, 0x98, 0xCC, 0xA8, 0x09, 0xF9, 0xD9,
        0x82, 0x92, 0xA8, 0xF5, 0x7C, 0xF1, 0x88, 0x3A, 0xCF, 0x94, 0x4A, 0x6E, 0x98, 0xDB, 0x69, 0x31, 0xDA, 0xAD,
        0xF2, 0xDE, 0xF9, 0xD8, 0x87, 0x95, 0xA8, 0xF2, 0x21, 0xD1, 0xDA, 0xA5, 0xF9, 0xF4, 0x17, 0xD9, 0xF1, 0xAE,
        0x8E, 0xD0, 0xC0, 0xC3, 0xAE, 0x82, 0xC6, 0x84, 0xC3, 0xA8, 0x85, 0x95, 0xC8, 0xA5, 0x88, 0xF2, 0xC0, 0xF1,
        0xF4, 0x01, 0x0E, 0xF1, 0x8E, 0x9E, 0xA8, 0xC6, 0x3E, 0x56, 0xF5, 0x54, 0xF1, 0x88, 0x72, 0xF4, 0x01, 0x15,
        0xF1, 0x98, 0x45, 0x85, 0x6E, 0xF5, 0x8E, 0x9E, 0x04, 0x88, 0xF1, 0x42, 0x98, 0x5A, 0x8E, 0x9E, 0x06, 0x88,
        0x69, 0xF4, 0x01, 0x1C, 0xF1, 0x98, 0x1E, 0x11, 0x08, 0xD0, 0xF5, 0x04, 0xF1, 0x1E, 0x97, 0x02, 0x02, 0x98,
        0x36, 0x25, 0xDB, 0xF9, 0xD9, 0x85, 0xA5, 0xF3, 0xC1, 0xDA, 0x85, 0xA5, 0xF3, 0xDF, 0xD8, 0x85, 0x95, 0xA8,
        0xF3, 0x09, 0xDA, 0xA5, 0xFA, 0xD8, 0x82, 0x92, 0xA8, 0xF5, 0x78, 0xF1, 0x88, 0x1A, 0x84, 0x9F, 0x26, 0x88,
        0x98, 0x21, 0xDA, 0xF4, 0x1D, 0xF3, 0xD8, 0x87, 0x9F, 0x39, 0xD1, 0xAF, 0xD9, 0xDF, 0xDF, 0xFB, 0xF9, 0xF4,
        0x0C, 0xF3, 0xD8, 0xFA, 0xD0, 0xF8, 0xDA, 0xF9, 0xF9, 0xD0, 0xDF, 0xD9, 0xF9, 0xD8, 0xF4, 0x0B, 0xD8, 0xF3,
        0x87, 0x9F, 0x39, 0xD1, 0xAF, 0xD9, 0xDF, 0xDF, 0xF4, 0x1D, 0xF3, 0xD8, 0xFA, 0xFC, 0xA8, 0x69, 0xF9, 0xF9,
        0xAF, 0xD0, 0xDA, 0xDE, 0xFA, 0xD9, 0xF8, 0x8F, 0x9F, 0xA8, 0xF1, 0xCC, 0xF3, 0x98, 0xDB, 0x45, 0xD9, 0xAF,
        0xDF, 0xD0, 0xF8, 0xD8, 0xF1, 0x8F, 0x9F, 0xA8, 0xCA, 0xF3, 0x88, 0x09, 0xDA, 0xAF, 0x8F, 0xCB, 0xF8, 0xD8,
        0xF2, 0xAD, 0x97, 0x8D, 0x0C, 0xD9, 0xA5, 0xDF, 0xF9, 0xBA, 0xA6, 0xF3, 0xFA, 0xF4, 0x12, 0xF2, 0xD8, 0x95,
        0x0D, 0xD1, 0xD9, 0xBA, 0xA6, 0xF3, 0xFA, 0xDA, 0xA5, 0xF2, 0xC1, 0xBA, 0xA6, 0xF3, 0xDF, 0xD8, 0xF1, 0xBA,
        0xB2, 0xB6, 0x86, 0x96, 0xA6, 0xD0, 0xCA, 0xF3, 0x49, 0xDA, 0xA6, 0xCB, 0xF8, 0xD8, 0xB0, 0xB4, 0xB8, 0xD8,
        0xAD, 0x84, 0xF2, 0xC0, 0xDF, 0xF1, 0x8F, 0xCB, 0xC3, 0xA8, 0xB2, 0xB6, 0x86, 0x96, 0xC8, 0xC1, 0xCB, 0xC3,
        0xF3, 0xB0, 0xB4, 0x88, 0x98, 0xA8, 0x21, 0xDB, 0x71, 0x8D, 0x9D, 0x71, 0x85, 0x95, 0x21, 0xD9, 0xAD, 0xF2,
        0xFA, 0xD8, 0x85, 0x97, 0xA8, 0x28, 0xD9, 0xF4, 0x08, 0xD8, 0xF2, 0x8D, 0x29, 0xDA, 0xF4, 0x05, 0xD9, 0xF2,
        0x85, 0xA4, 0xC2, 0xF2, 0xD8, 0xA8, 0x8D, 0x94, 0x01, 0xD1, 0xD9, 0xF4, 0x11, 0xF2, 0xD8, 0x87, 0x21, 0xD8,
        0xF4, 0x0A, 0xD8, 0xF2, 0x84, 0x98, 0xA8, 0xC8, 0x01, 0xD1, 0xD9, 0xF4, 0x11, 0xD8, 0xF3, 0xA4, 0xC8, 0xBB,
        0xAF, 0xD0, 0xF2, 0xDE, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xD8, 0xF1, 0xB8, 0xF6, 0xB5, 0xB9,
        0xB0, 0x8A, 0x95, 0xA3, 0xDE, 0x3C, 0xA3, 0xD9, 0xF8, 0xD8, 0x5C, 0xA3, 0xD9, 0xF8, 0xD8, 0x7C, 0xA3, 0xD9,
        0xF8, 0xD8, 0xF8, 0xF9, 0xD1, 0xA5, 0xD9, 0xDF, 0xDA, 0xFA, 0xD8, 0xB1, 0x85, 0x30, 0xF7, 0xD9, 0xDE, 0xD8,
        0xF8, 0x30, 0xAD, 0xDA, 0xDE, 0xD8, 0xF2, 0xB4, 0x8C, 0x99, 0xA3, 0x2D, 0x55, 0x7D, 0xA0, 0x83, 0xDF, 0xDF,
        0xDF, 0xB5, 0x91, 0xA0, 0xF6, 0x29, 0xD9, 0xFB, 0xD8, 0xA0, 0xFC, 0x29, 0xD9, 0xFA, 0xD8, 0xA0, 0xD0, 0x51,
        0xD9, 0xF8, 0xD8, 0xFC, 0x51, 0xD9, 0xF9, 0xD8, 0x79, 0xD9, 0xFB, 0xD8, 0xA0, 0xD0, 0xFC, 0x79, 0xD9, 0xFA,
        0xD8, 0xA1, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xA0, 0xDA, 0xDF, 0xDF, 0xDF, 0xD8, 0xA1, 0xF8, 0xF8, 0xF8, 0xF8,
        0xF8, 0xAC, 0xDE, 0xF8, 0xAD, 0xDE, 0x83, 0x93, 0xAC, 0x2C, 0x54, 0x7C, 0xF1, 0xA8, 0xDF, 0xDF, 0xDF, 0xF6,
        0x9D, 0x2C, 0xDA, 0xA0, 0xDF, 0xD9, 0xFA, 0xDB, 0x2D, 0xF8, 0xD8, 0xA8, 0x50, 0xDA, 0xA0, 0xD0, 0xDE, 0xD9,
        0xD0, 0xF8, 0xF8, 0xF8, 0xDB, 0x55, 0xF8, 0xD8, 0xA8, 0x78, 0xDA, 0xA0, 0xD0, 0xDF, 0xD9, 0xD0, 0xFA, 0xF8,
        0xF8, 0xF8, 0xF8, 0xDB, 0x7D, 0xF8, 0xD8, 0x9C, 0xA8, 0x8C, 0xF5, 0x30, 0xDB, 0x38, 0xD9, 0xD0, 0xDE, 0xDF,
        0xA0, 0xD0, 0xDE, 0xDF, 0xD8, 0xA8, 0x48, 0xDB, 0x58, 0xD9, 0xDF, 0xD0, 0xDE, 0xA0, 0xDF, 0xD0, 0xDE, 0xD8,
        0xA8, 0x68, 0xDB, 0x70, 0xD9, 0xDF, 0xDF, 0xA0, 0xDF, 0xDF, 0xD8, 0xF1, 0xA8, 0x88, 0x90, 0x2C, 0x54, 0x7C,
        0x98, 0xA8, 0xD0, 0x5C, 0x38, 0xD1, 0xDA, 0xF2, 0xAE, 0x8C, 0xDF, 0xF9, 0xD8, 0xB0, 0x87, 0xA8, 0xC1, 0xC1,
        0xB1, 0x88, 0xA8, 0xC6, 0xF9, 0xF9, 0xDA, 0x36, 0xD8, 0xA8, 0xF9, 0xDA, 0x36, 0xD8, 0xA8, 0xF9, 0xDA, 0x36,
        0xD8, 0xA8, 0xF9, 0xDA, 0x36, 0xD8, 0xA8, 0xF9, 0xDA, 0x36, 0xD8, 0xF7, 0x8D, 0x9D, 0xAD, 0xF8, 0x18, 0xDA,
        0xF2, 0xAE, 0xDF, 0xD8, 0xF7, 0xAD, 0xFA, 0x30, 0xD9, 0xA4, 0xDE, 0xF9, 0xD8, 0xF2, 0xAE, 0xDE, 0xFA, 0xF9,
        0x83, 0xA7, 0xD9, 0xC3, 0xC5, 0xC7, 0xF1, 0x88, 0x9B, 0xA7, 0x7A, 0xAD, 0xF7, 0xDE, 0xDF, 0xA4, 0xF8, 0x84,
        0x94, 0x08, 0xA7, 0x97, 0xF3, 0x00, 0xAE, 0xF2, 0x98, 0x19, 0xA4, 0x88, 0xC6, 0xA3, 0x94, 0x88, 0xF6, 0x32,
        0xDF, 0xF2, 0x83, 0x93, 0xDB, 0x09, 0xD9, 0xF2, 0xAA, 0xDF, 0xD8, 0xD8, 0xAE, 0xF8, 0xF9, 0xD1, 0xDA, 0xF3,
        0xA4, 0xDE, 0xA7, 0xF1, 0x88, 0x9B, 0x7A, 0xD8, 0xF3, 0x84, 0x94, 0xAE, 0x19, 0xF9, 0xDA, 0xAA, 0xF1, 0xDF,
        0xD8, 0xA8, 0x81, 0xC0, 0xC3, 0xC5, 0xC7, 0xA3, 0x92, 0x83, 0xF6, 0x28, 0xAD, 0xDE, 0xD9, 0xF8, 0xD8, 0xA3,
        0x50, 0xAD, 0xD9, 0xF8, 0xD8, 0xA3, 0x78, 0xAD, 0xD9, 0xF8, 0xD8, 0xF8, 0xF9, 0xD1, 0xA1, 0xDA, 0xDE, 0xC3,
        0xC5, 0xC7, 0xD8, 0xA1, 0x81, 0x94, 0xF8, 0x18, 0xF2, 0xB0, 0x89, 0xAC, 0xC3, 0xC5, 0xC7, 0xF1, 0xD8, 0xB8,
        0xB4, 0xB0, 0x97, 0x86, 0xA8, 0x31, 0x9B, 0x06, 0x99, 0x07, 0xAB, 0x97, 0x28, 0x88, 0x9B, 0xF0, 0x0C, 0x20,
        0x14, 0x40, 0xB0, 0xB4, 0xB8, 0xF0, 0xA8, 0x8A, 0x9A, 0x28, 0x50, 0x78, 0xB7, 0x9B, 0xA8, 0x29, 0x51, 0x79,
        0x24, 0x70, 0x59, 0x44, 0x69, 0x38, 0x64, 0x48, 0x31, 0xF1, 0xBB, 0xAB, 0x88, 0x00, 0x2C, 0x54, 0x7C, 0xF0,
        0xB3, 0x8B, 0xB8, 0xA8, 0x04, 0x28, 0x50, 0x78, 0xF1, 0xB0, 0x88, 0xB4, 0x97, 0x26, 0xA8, 0x59, 0x98, 0xBB,
        0xAB, 0xB3, 0x8B, 0x02, 0x26, 0x46, 0x66, 0xB0, 0xB8, 0xF0, 0x8A, 0x9C, 0xA8, 0x29, 0x51, 0x79, 0x8B, 0x29,
        0x51, 0x79, 0x8A, 0x24, 0x70, 0x59, 0x8B, 0x20, 0x58, 0x71, 0x8A, 0x44, 0x69, 0x38, 0x8B, 0x39, 0x40, 0x68,
        0x8A, 0x64, 0x48, 0x31, 0x8B, 0x30, 0x49, 0x60, 0x88, 0xF1, 0xAC, 0x00, 0x2C, 0x54, 0x7C, 0xF0, 0x8C, 0xA8,
        0x04, 0x28, 0x50, 0x78, 0xF1, 0x88, 0x97, 0x26, 0xA8, 0x59, 0x98, 0xAC, 0x8C, 0x02, 0x26, 0x46, 0x66, 0xF0,
        0x89, 0x9C, 0xA8, 0x29, 0x51, 0x79, 0x24, 0x70, 0x59, 0x44, 0x69, 0x38, 0x64, 0x48, 0x31, 0xA9, 0x88, 0x09,
        0x20, 0x59, 0x70, 0xAB, 0x11, 0x38, 0x40, 0x69, 0xA8, 0x19, 0x31, 0x48, 0x60, 0x8C, 0xA8, 0x3C, 0x41, 0x5C,
        0x20, 0x7C, 0x00, 0xF1, 0x87, 0x98, 0x19, 0x86, 0xA8, 0x6E, 0x76, 0x7E, 0xA9, 0x99, 0x88, 0x2D, 0x55, 0x7D,
        0xD8, 0xB1, 0xB5, 0xB9, 0xA3, 0xDF, 0xDF, 0xDF, 0xAE, 0xD0, 0xDF, 0xAA, 0xD0, 0xDE, 0xF2, 0xAB, 0xF8, 0xF9,
        0xD9, 0xB0, 0x87, 0xC4, 0xAA, 0xF1, 0xDF, 0xDF, 0xBB, 0xAF, 0xDF, 0xDF, 0xB9, 0xD8, 0xB1, 0xF1, 0xA3, 0x97,
        0x8E, 0x60, 0xDF, 0xB0, 0x84, 0xF2, 0xC8, 0xF8, 0xF9, 0xD9, 0xDE, 0xD8, 0x93, 0x85, 0xF1, 0x4A, 0xB1, 0x83,
        0xA3, 0x08, 0xB5, 0x83, 0x9A, 0x08, 0x10, 0xB7, 0x9F, 0x10, 0xD8, 0xF1, 0xB0, 0xBA, 0xAE, 0xB0, 0x8A, 0xC2,
        0xB2, 0xB6, 0x8E, 0x9E, 0xF1, 0xFB, 0xD9, 0xF4, 0x1D, 0xD8, 0xF9, 0xD9, 0x0C, 0xF1, 0xD8, 0xF8, 0xF8, 0xAD,
        0x61, 0xD9, 0xAE, 0xFB, 0xD8, 0xF4, 0x0C, 0xF1, 0xD8, 0xF8, 0xF8, 0xAD, 0x19, 0xD9, 0xAE, 0xFB, 0xDF, 0xD8,
        0xF4, 0x16, 0xF1, 0xD8, 0xF8, 0xAD, 0x8D, 0x61, 0xD9, 0xF4, 0xF4, 0xAC, 0xF5, 0x9C, 0x9C, 0x8D, 0xDF, 0x2B,
        0xBA, 0xB6, 0xAE, 0xFA, 0xF8, 0xF4, 0x0B, 0xD8, 0xF1, 0xAE, 0xD0, 0xF8, 0xAD, 0x51, 0xDA, 0xAE, 0xFA, 0xF8,
        0xF1, 0xD8, 0xB9, 0xB1, 0xB6, 0xA3, 0x83, 0x9C, 0x08, 0xB9, 0xB1, 0x83, 0x9A, 0xB5, 0xAA, 0xC0, 0xFD, 0x30,
        0x83, 0xB7, 0x9F, 0x10, 0xB5, 0x8B, 0x93, 0xF2, 0x02, 0x02, 0xD1, 0xAB, 0xDA, 0xDE, 0xD8, 0xF1, 0xB0, 0x80,
        0xBA, 0xAB, 0xC0, 0xC3, 0xB2, 0x84, 0xC1, 0xC3, 0xD8, 0xB1, 0xB9, 0xF3, 0x8B, 0xA3, 0x91, 0xB6, 0x09, 0xB4,
        0xD9, 0xAB, 0xDE, 0xB0, 0x87, 0x9C, 0xB9, 0xA3, 0xDD, 0xF1, 0xB3, 0x8B, 0x8B, 0x8B, 0x8B, 0x8B, 0xB0, 0x87,
        0x20, 0x28, 0x30, 0x38, 0xB2, 0x8B, 0xB6, 0x9B, 0xF2, 0xA3, 0xC0, 0xC8, 0xC2, 0xC4, 0xCC, 0xC6, 0xA3, 0xA3,
        0xA3, 0xF1, 0xB0, 0x87, 0xB5, 0x9A, 0xD8, 0xF3, 0x9B, 0xA3, 0xA3, 0xDC, 0xBA, 0xAC, 0xDF, 0xB9, 0xA3, 0xFE,
        0xF2, 0xAB, 0xC4, 0xAA, 0xF1, 0xDF, 0xDF, 0xBB, 0xAF, 0xDF, 0xDF, 0xA3, 0xA3, 0xA3, 0xD8, 0xD8, 0xD8, 0xBB,
        0xB3, 0xB7, 0xF1, 0xAA, 0xF9, 0xDA, 0xFF, 0xD9, 0x80, 0x9A, 0xAA, 0x28, 0xB4, 0x80, 0x98, 0xA7, 0x20, 0xB7,
        0x97, 0x87, 0xA8, 0x66, 0x88, 0xF0, 0x79, 0x51, 0xF1, 0x90, 0x2C, 0x87, 0x0C, 0xA7, 0x81, 0x97, 0x62, 0x93,
        0xF0, 0x71, 0x71, 0x60, 0x85, 0x94, 0x01, 0x29, 0x51, 0x79, 0x90, 0xA5, 0xF1, 0x28, 0x4C, 0x6C, 0x87, 0x0C,
        0x95, 0x18, 0x85, 0x78, 0xA3, 0x83, 0x90, 0x28, 0x4C, 0x6C, 0x88, 0x6C, 0xD8, 0xF3, 0xA2, 0x82, 0x00, 0xF2,
        0x10, 0xA8, 0x92, 0x19, 0x80, 0xA2, 0xF2, 0xD9, 0x26, 0xD8, 0xF1, 0x88, 0xA8, 0x4D, 0xD9, 0x48, 0xD8, 0x96,
        0xA8, 0x39, 0x80, 0xD9, 0x3C, 0xD8, 0x95, 0x80, 0xA8, 0x39, 0xA6, 0x86, 0x98, 0xD9, 0x2C, 0xDA, 0x87, 0xA7,
        0x2C, 0xD8, 0xA8, 0x89, 0x95, 0x19, 0xA9, 0x80, 0xD9, 0x38, 0xD8, 0xA8, 0x89, 0x39, 0xA9, 0x80, 0xDA, 0x3C,
        0xD8, 0xA8, 0x2E, 0xA8, 0x39, 0x90, 0xD9, 0x0C, 0xD8, 0xA8, 0x95, 0x31, 0x98, 0xD9, 0x0C, 0xD8, 0xA8, 0x09,
        0xD9, 0xFF, 0xD8, 0x01, 0xDA, 0xFF, 0xD8, 0x95, 0x39, 0xA9, 0xDA, 0x26, 0xFF, 0xD8, 0x90, 0xA8, 0x0D, 0x89,
        0x99, 0xA8, 0x10, 0x80, 0x98, 0x21, 0xDA, 0x2E, 0xD8, 0x89, 0x99, 0xA8, 0x31, 0x80, 0xDA, 0x2E, 0xD8, 0xA8,
        0x86, 0x96, 0x31, 0x80, 0xDA, 0x2E, 0xD8, 0xA8, 0x87, 0x31, 0x80, 0xDA, 0x2E, 0xD8, 0xA8, 0x82, 0x92, 0xF3,
        0x41, 0x80, 0xF1, 0xD9, 0x2E, 0xD8, 0xA8, 0x82, 0xF3, 0x19, 0x80, 0xF1, 0xD9, 0x2E, 0xD8, 0x82, 0xAC, 0xF3,
        0xC0, 0xA2, 0x80, 0x22, 0xF1, 0xA6, 0x2E, 0xA7, 0x2E, 0xA9, 0x22, 0x98, 0xA8, 0x29, 0xDA, 0xAC, 0xDE, 0xFF,
        0xD8, 0xA2, 0xF2, 0x2A, 0xF1, 0xA9, 0x2E, 0x82, 0x92, 0xA8, 0xF2, 0x31, 0x80, 0xA6, 0x96, 0xF1, 0xD9, 0x00,
        0xAC, 0x8C, 0x9C, 0x0C, 0x30, 0xAC, 0xDE, 0xD0, 0xDE, 0xFF, 0xD8, 0x8C, 0x9C, 0xAC, 0xD0, 0x10, 0xAC, 0xDE,
        0x80, 0x92, 0xA2, 0xF2, 0x4C, 0x82, 0xA8, 0xF1, 0xCA, 0xF2, 0x35, 0xF1, 0x96, 0x88, 0xA6, 0xD9, 0x00, 0xD8,
        0xF1, 0xFF};

    void writeReg(uint8_t reg, uint8_t val) { I2CBus::instance().writeReg(_addr, reg, &val, 1); }

    uint8_t readReg(uint8_t reg) {
        uint8_t val = 0;
        I2CBus::instance().readReg(_addr, reg, &val, 1);
        return val;
    }

    void writeBit(uint8_t reg, uint8_t bit, uint8_t val) {
        uint8_t b = readReg(reg);
        b = val ? (b | (1 << bit)) : (b & ~(1 << bit));
        writeReg(reg, b);
    }

    void writeBits(uint8_t reg, uint8_t startBit, uint8_t len, uint8_t val) {
        uint8_t b = readReg(reg);
        uint8_t mask = ((1 << len) - 1) << (startBit - len + 1);
        val <<= (startBit - len + 1);
        b = (b & ~mask) | (val & mask);
        writeReg(reg, b);
    }

    void setDMPEnabled(bool enabled) { writeBit(REG_USER_CTRL, 7, enabled ? 1 : 0); }

    uint16_t getFIFOCount() {
        uint8_t buf[2];
        I2CBus::instance().readReg(_addr, REG_FIFO_COUNT_H, buf, 2);
        return (buf[0] << 8) | buf[1];
    }

    void resetFIFO() { writeBit(REG_USER_CTRL, 2, 1); }

    void setMemoryBank(uint8_t bank) { writeReg(REG_BANK_SEL, bank & 0x1F); }

    void setMemoryStartAddress(uint8_t address) { writeReg(REG_MEM_START_ADDR, address); }

    bool writeMemoryBlock(const uint8_t* data, uint16_t dataSize, uint8_t bank, uint8_t address) {
        uint8_t chunkSize;
        uint16_t i = 0;

        setMemoryBank(bank);
        setMemoryStartAddress(address);

        while (i < dataSize) {
            chunkSize = 16;
            if (i + chunkSize > dataSize) chunkSize = dataSize - i;
            if (address + chunkSize > 256) chunkSize = 256 - address;

            I2CBus::instance().writeReg(_addr, REG_MEM_R_W, data + i, chunkSize);

            i += chunkSize;
            address += chunkSize;

            if (address == 0) {
                bank++;
                setMemoryBank(bank);
            }

            if (address > 0) {
                setMemoryStartAddress(address);
            }
        }
        return true;
    }

    int dmpInitialize() {
        writeBit(REG_PWR_MGMT_1, 7, 1);
        vTaskDelay(pdMS_TO_TICKS(100));

        writeBits(REG_USER_CTRL, 2, 3, 0b111);
        vTaskDelay(pdMS_TO_TICKS(100));

        writeReg(REG_PWR_MGMT_1, 0x01);
        writeReg(REG_INT_ENABLE, 0x00);
        writeReg(REG_FIFO_EN, 0x00);
        writeReg(REG_ACCEL_CONFIG, 0x00);
        writeReg(REG_INT_PIN_CFG, 0x82);
        writeReg(REG_PWR_MGMT_1, 0x01);
        writeReg(REG_SMPLRT_DIV, 0x04);
        writeReg(REG_CONFIG, 0x01);

        if (!writeMemoryBlock(dmpMemory, DMP_CODE_SIZE, 0, 0)) return 1;

        uint8_t verify[2];
        setMemoryBank(0);
        setMemoryStartAddress(0);
        I2CBus::instance().readReg(_addr, REG_MEM_R_W, verify, 2);
        if (verify[0] != 0x00 || verify[1] != 0xF8) return 2;

        uint8_t dmpStart[2] = {0x04, 0x00};
        I2CBus::instance().writeReg(_addr, REG_DMP_CFG_1, dmpStart, 2);

        writeReg(REG_GYRO_CONFIG, 0x18);
        writeReg(REG_USER_CTRL, 0xC0);
        writeReg(REG_INT_ENABLE, 0x02);
        resetFIFO();

        setDMPEnabled(false);

        return 0;
    }

    bool dmpGetCurrentFIFOPacket(uint8_t* data) {
        int16_t fifoC = getFIFOCount();

        if (fifoC > 200) {
            resetFIFO();
            uint32_t start = xTaskGetTickCount();
            fifoC = 0;
            while (!fifoC && (xTaskGetTickCount() - start) < pdMS_TO_TICKS(100)) {
                vTaskDelay(pdMS_TO_TICKS(2));
                fifoC = getFIFOCount();
            }
        } else if (fifoC > DMP_PACKET_SIZE) {
            uint8_t trash[32];
            while ((fifoC = getFIFOCount()) > DMP_PACKET_SIZE) {
                uint16_t toRemove = fifoC - DMP_PACKET_SIZE;
                while (toRemove > 0) {
                    uint8_t chunk = (toRemove < 32) ? toRemove : 32;
                    I2CBus::instance().readReg(_addr, REG_FIFO_R_W, trash, chunk);
                    toRemove -= chunk;
                }
            }
        }

        if (!fifoC) return false;
        if (fifoC != DMP_PACKET_SIZE) return false;

        I2CBus::instance().readReg(_addr, REG_FIFO_R_W, data, DMP_PACKET_SIZE);
        return true;
    }

    void dmpGetQuaternion(float* q, const uint8_t* packet) {
        int16_t qI[4];
        qI[0] = (packet[0] << 8) | packet[1];
        qI[1] = (packet[4] << 8) | packet[5];
        qI[2] = (packet[8] << 8) | packet[9];
        qI[3] = (packet[12] << 8) | packet[13];
        q[0] = qI[0] / 16384.0f;
        q[1] = qI[1] / 16384.0f;
        q[2] = qI[2] / 16384.0f;
        q[3] = qI[3] / 16384.0f;
    }

    void dmpGetGravity(float* g, const float* q) {
        g[0] = 2.0f * (q[1] * q[3] - q[0] * q[2]);
        g[1] = 2.0f * (q[0] * q[1] + q[2] * q[3]);
        g[2] = q[0] * q[0] - q[1] * q[1] - q[2] * q[2] + q[3] * q[3];
    }

    void dmpGetYawPitchRoll(float* ypr, const float* q, const float* gravity) {
        ypr[0] = atan2f(2.0f * q[1] * q[2] - 2.0f * q[0] * q[3], 2.0f * q[0] * q[0] + 2.0f * q[1] * q[1] - 1.0f);
        ypr[1] = atan2f(gravity[0], sqrtf(gravity[1] * gravity[1] + gravity[2] * gravity[2]));
        ypr[2] = atan2f(gravity[1], gravity[2]);
        if (gravity[2] < 0) {
            if (ypr[1] > 0) {
                ypr[1] = M_PI - ypr[1];
            } else {
                ypr[1] = -M_PI - ypr[1];
            }
        }
    }

    void CalibrateGyro(int loops) {
        float kP = 0.3f;
        float kI = 90.0f;
        float x = (100.0f - (loops < 1 ? 20 : (loops > 5 ? 0 : 20 - (loops - 1) * 5))) * 0.01f;
        kP *= x;
        kI *= x;
        PID(REG_GYRO_XOUT_H, kP, kI, loops);
    }

    void CalibrateAccel(int loops) {
        float kP = 0.3f;
        float kI = 20.0f;
        float x = (100.0f - (loops < 1 ? 20 : (loops > 5 ? 0 : 20 - (loops - 1) * 5))) * 0.01f;
        kP *= x;
        kI *= x;
        PID(REG_ACCEL_XOUT_H, kP, kI, loops);
    }

    void PID(uint8_t readAddr, float kP, float kI, int loops) {
        uint8_t saveAddr = (readAddr == REG_ACCEL_XOUT_H) ? REG_XA_OFFS_H : REG_XG_OFFS_USRH;
        uint8_t shift = (readAddr == REG_ACCEL_XOUT_H) ? 2 : 2;

        int16_t data;
        float reading;
        int16_t bitZero[3] = {0, 0, 0};
        float iTerm[3] = {0, 0, 0};
        int16_t gravity = 16384;

        for (int i = 0; i < 3; i++) {
            uint8_t buf[2];
            I2CBus::instance().readReg(_addr, saveAddr + (i * shift), buf, 2);
            data = (buf[0] << 8) | buf[1];
            reading = data;
            if (readAddr == REG_ACCEL_XOUT_H) {
                bitZero[i] = data & 1;
                iTerm[i] = reading * 8.0f;
            } else {
                iTerm[i] = reading * 4.0f;
            }
        }

        for (int l = 0; l < loops; l++) {
            for (int c = 0; c < 100; c++) {
                for (int i = 0; i < 3; i++) {
                    uint8_t buf[2];
                    I2CBus::instance().readReg(_addr, readAddr + (i * 2), buf, 2);
                    data = (buf[0] << 8) | buf[1];
                    reading = data;

                    if (readAddr == REG_ACCEL_XOUT_H && i == 2) reading -= gravity;

                    float error = -reading;
                    float pTerm = kP * error;
                    iTerm[i] += (error * 0.001f) * kI;

                    if (readAddr == REG_ACCEL_XOUT_H) {
                        data = (int16_t)roundf((pTerm + iTerm[i]) / 8.0f);
                        data = (data & 0xFFFE) | bitZero[i];
                    } else {
                        data = (int16_t)roundf((pTerm + iTerm[i]) / 4.0f);
                    }

                    uint8_t outBuf[2] = {(uint8_t)(data >> 8), (uint8_t)(data & 0xFF)};
                    I2CBus::instance().writeReg(_addr, saveAddr + (i * shift), outBuf, 2);
                }
                vTaskDelay(pdMS_TO_TICKS(1));
            }
            kP *= 0.75f;
            kI *= 0.75f;
        }
    }

    uint8_t _addr;
    bool _initialized = false;
    uint8_t _fifoBuffer[DMP_PACKET_SIZE];
    float _gravity[3] = {0};
    float _rpy[3] = {0};
    float _temp = 0;
};
